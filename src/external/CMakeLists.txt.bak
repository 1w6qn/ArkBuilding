project(albcexternals)
include(ExternalProject)

set(CMAKE_CXX_STANDARD 14)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

set(CMAKE_WARN_DEPRECATED OFF CACHE BOOL "" FORCE)
set(ALBC_SUBPROJECT_INSTALL_DIR ${CMAKE_CURRENT_SOURCE_DIR}/build)
set(ALBC_SUBPROJECT_BINARY_DIR ${ALBC_SUBPROJECT_INSTALL_DIR}/bin)

ExternalProject_Add(jsoncpp
    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/jsoncpp
    BINARY_DIR ${ALBC_SUBPROJECT_BINARY_DIR}/jsoncpp
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=${ALBC_SUBPROJECT_INSTALL_DIR}/jsoncpp)

ExternalProject_Add(concurrentqueue
    SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/concurrentqueue
    BINARY_DIR ${ALBC_SUBPROJECT_BINARY_DIR}/concurrentqueue
    CMAKE_ARGS -DCMAKE_INSTALL_PREFIX:PATH=${ALBC_SUBPROJECT_INSTALL_DIR}/concurrentqueue)

add_subdirectory(coin)

set(COIN_LIBS_PATH
        coin/Cbc/CoinUtils
        coin/Cbc/Clp
        coin/Cbc/Clp/src/OsiClp
        coin/Cbc/Osi/src/Osi
        coin/Cbc/Cbc
        coin/Cbc/Cbc/src/OsiCbc)

foreach(name AllDifferent Clique DuplicateRow FlowCover GMI Gomory
              KnapsackCover LandP LiftAndProject MixedIntegerRounding
              MixedIntegerRounding2 OddHole PreProcess Probing RedSplit
              RedSplit2 ResidualCapacity SimpleRounding Twomir ZeroHalf)
    set(COIN_LIBS_PATH ${COIN_LIBS_PATH} coin/Cbc/Cgl/src/Cgl${name})
endforeach()

set(COIN_INCLUDE_DIRS
        coin/Cbc/BuildTools/headers)

function(add_coin_library path)
    get_filename_component(name ${path} NAME)
    set(COIN_LIBS ${COIN_LIBS} ${name} PARENT_SCOPE)

    set(src_path ${path})
    if (EXISTS ${PROJECT_SOURCE_DIR}/${path}/src)
        set(src_path ${path}/src)
    endif ()

    set(COIN_INCLUDE_DIRS ${COIN_INCLUDE_DIRS} ${src_path} PARENT_SCOPE)
    message(STATUS "Added ${name} at ${path}")
endfunction()

foreach(path ${COIN_LIBS_PATH})
    add_coin_library(${path})
endforeach()

message(STATUS "Coin libraries: ${COIN_LIBS}")
message(STATUS "Coin include dirs: ${COIN_INCLUDE_DIRS}")

set(ALBC_EXTERNAL_LIBS
        ${COIN_LIBS})

set(ALBC_EXTERNAL_INCLUDE_DIRS
        ${COIN_INCLUDE_DIRS})

aux_source_directory(. ALBC_EXTERNAL_SRC_FILES)


add_library(albcexternals STATIC ${ALBC_EXTERNAL_SRC_FILES})
add_dependencies(albcexternals jsoncpp concurrentqueue)

target_link_libraries(albcexternals PUBLIC ${ALBC_EXTERNAL_LIBS})
target_include_directories(albcexternals PUBLIC ${ALBC_EXTERNAL_INCLUDE_DIRS} include)
target_compile_definitions(albcexternals PUBLIC HAVE_CONFIG_H=1)